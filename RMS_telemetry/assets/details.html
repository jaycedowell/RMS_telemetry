<!DOCTYPE html>
<html lang='en' xml:lang='en' xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>RMS_telemetry</title>
  <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.3/css/dataTables.dataTables.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.3/js/dataTables.min.js"></script>
  <script type="text/javascript">
  function updateListing(response, status, xhr) {
    if( document.title === 'RMS_telemetry' ) {
      document.title = response['station_id'];
    }
    
    var sp = document.getElementById('date');
    if( sp != null ) {
      sp.innerHTML = response['capture_started'].slice(0, 10);
      sp.classList.remove("loading");
    }
    
    var tbl = document.getElementById('listing');
    if( tbl != null ) {
      var contents = '<thead><tr><th>Date/Time</th><th>Magnitude</th><th>Duration</th><th>Shower</th><th>Link</th></thead>';
      contents += '<tbody>';
        
      for(var idx in response['meteors']) {
        var entry = response['meteors'][idx];
        contents += '<tr><td>' + entry['date'].slice(0, -3) + '</td>';
        contents += '<td>' + entry['mag'].toFixed(2) + '</td>';
        contents += '<td>' + entry['dur'].toFixed(3) + ' s</td>';
        contents += '<td>' + entry['shower'] + '</td>';
        contents += '<td><a href="/previous/meteor?date=' + entry['date'] + '">Image</a> | <a href="/previous/meteor?date=' + entry['date'] + '&format=mp4">Movie</a></td></tr>';
      }
      contents += '</tbody>';
    }
    
    tbl.innerHTML = contents;
  }
  
  function fetchListing() {
    var url = '/previous/details'
    
    var parts = window.location.href.split("?");
    if( parts.length == 2) {
      url += '?' + parts[1];
    }
    
    $.ajax({'url': url,
            'success': function(response, status, xhr) {
              updateListing(response, status, xhr);
              $('#listing').DataTable({'order': [[0, 'asc']],
                                       'columnDefs': [{'targets': 4, 'orderable': false},
                                                      {'className': 'dt-center', 'targets': [1, 2]}
                                                     ],
                                       'pageLength': 50
                                      });
            },
            'error': function() {
              setTimeout(fetchListing, 5000);
            }
           });
  }
  </script>
</head>
<body onload="fetchListing();">
  <h2>Meteor Details for <span id="date" class="loading">Loading...</span></h2>
  <table id="listing" class="display"></table>
</body>
</html>
