<!DOCTYPE html>
<html lang='en' xml:lang='en' xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>RMS_telemetry</title>
  <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.3/css/dataTables.dataTables.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.3/js/dataTables.min.js"></script>
  <script type="text/javascript">
  
  var dtable = null;
  
  function updateListing(response, status, xhr) {
    if( document.title === 'RMS_telemetry' ) {
      document.title = response['station_id'];
    }
    
    var sp = document.getElementById('date');
    if( sp != null ) {
      sp.innerHTML = response['capture_started'].slice(0, 10);
      sp.classList.remove("loading");
    }
    
    var tbl = document.getElementById('listing');
    if( tbl != null ) {
      var contents = '<thead><tr><th>Date/Time</th><th>Magnitude</th><th>Duration</th><th>Shower</th><th>Link</th><th>GMN Entry?</th></thead>';
      contents += '<tbody>';
      
      for(var idx in response['meteors']) {
        var entry = response['meteors'][idx];
        contents += '<tr><td>' + entry['date'].slice(0, -3) + '</td>';
        contents += '<td>' + entry['mag'].toFixed(2) + '</td>';
        contents += '<td>' + entry['dur'].toFixed(3) + ' s</td>';
        contents += '<td>' + entry['shower'] + '</td>';
        contents += '<td><a href="/previous/meteor?date=' + entry['date'] + '">Image</a> | <a href="/previous/meteor?date=' + entry['date'] + '&duration=' + entry['dur'].toFixed(3) + '&format=mp4">Movie</a></td>';
        contents += '<td> </td></tr>';
      }
      contents += '</tbody>';
    }
    
    tbl.innerHTML = contents;
    
    if( response['meteors'].length > 0 ) {
      var start = response['meteors'][0]['date'];
      var stop = response['meteors'][response['meteors'].length-1]['date'];
      fetchTrajectories(start, stop);
    }
  }
  
  function fetchListing() {
    var url = '/previous/details'
    
    var parts = window.location.href.split("?");
    if( parts.length == 2) {
      url += '?' + parts[1];
    }
    
    $.ajax({'url': url,
            'success': function(response, status, xhr) {
              updateListing(response, status, xhr);
              dtable = $('#listing').DataTable({'order': [[0, 'asc']],
                                                'columnDefs': [{'targets': 4, 'orderable': false},
                                                               {'targets': 5, 'sType': 'string'},
                                                               {'targets': [1, 2], 'className': 'dt-center'}
                                                              ],
                                                'pageLength': 50
                                               });
            },
            'error': function() {
              setTimeout(fetchListing, 5000);
            }
           });
  }
  
  function updateTrajectories(response, status, xhr) {
    var tbl = document.getElementById("listing");
    if( tbl != null && dtable != null && response.ok ) {
        dtable.rows().every(function(rowIdx, tableLoop, rowLoop, data) {
          var row = this.node();
          try {
            var tstart = new Date(row.cells[0].textContent);
            
            for(var j=0; j<response['rows'].length; j++) {
              var entry = response['rows'][j];
              var tentry = new Date(entry['beginning_utc_time']);
              var diff = (tstart.getTime() - tentry.getTime()) / 1000;
              if( diff < -0.125 ) {
                continue;
              } else if( diff >= -0.125 && diff <= 0.125 ) {
                var glnk = row.cells[5];
                glnk.innerHTML += '<a name="' + entry['meteor_unique_trajectory_identifier'] + '" href="https://explore.globalmeteornetwork.org/gmn_data_store/meteor/' + entry['meteor_unique_trajectory_identifier'] + '" target="_blank" rel="noopener noreferrer">Yes <i class="icon-external-link"></i></a>';
                break;
              } else {
                break;
              }
            }
          } catch(err) {}
        });
    }
  }
  
  function fetchTrajectories(start_date, stop_date) {
    $.ajax({'url': "https://explore.globalmeteornetwork.org/gmn_data_store/-/query.json?sql=SELECT+ps_summary.meteor_unique_trajectory_identifier%2C+m.beginning_utc_time%2C+m.elev_deg%2C+m.latbeg_n_deg%2C+m.lonbeg_e_deg%2C+m.latend_n_deg%2C+m.lonend_e_deg%2C+m.htbeg_km%2C+m.htend_km%2C+m.duration_sec%2C+m.peak_absmag%2C+m.vgeo_km_s%2C+m.created_at+as+meteor_created_at%2C+m.updated_at+as+meteor_updated_at+FROM+%28+SELECT+meteor_unique_trajectory_identifier%2C+GROUP_CONCAT%28station_code%29+as+stations%2C+COUNT%28*%29+as+station_count%2C+MAX%28created_at%29+as+latest_created_at+FROM+participating_station+WHERE+meteor_unique_trajectory_identifier+IN+%28+SELECT+meteor_unique_trajectory_identifier+FROM+participating_station+WHERE+station_code+%3D+%27" + document.title + "%27%29+GROUP+BY+meteor_unique_trajectory_identifier+%29+AS+ps_summary+JOIN+meteor+m+ON+ps_summary.meteor_unique_trajectory_identifier+%3D+m.unique_trajectory_identifier+AND+m.beginning_utc_time+%3E%3D+%22" + start_date.replace('T', '%20') + "%22+AND+m.beginning_utc_time+%3C+%22" + stop_date.replace('T', '%20') + "%22+ORDER+BY+ps_summary.latest_created_at+DESC%3B",
            'success': function(response, status, xhr) {
              updateTrajectories(response, status, xhr);
            },
            'error': function() {
              setTimeout(fetchTrajectories, 15*1000);
            }
           });
  }
  </script>
</head>
<body onload="fetchListing();">
  <h2>Meteor Details for <span id="date" class="loading">Loading...</span></h2>
  <table id="listing" class="display"></table>
</body>
</html>
